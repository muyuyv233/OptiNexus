<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OptiNexus</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* 你的原有 CSS 代码保持不变，只需在最后添加以下样式 */
    .comment-author img.svip-badge {
      height: 1em;
      vertical-align: middle;
      margin-left: 5px;
      transition: transform 0.3s ease;
    }
    .comment-author img.svip-badge:hover {
      transform: scale(1.2);
    }
    
    /* 新增的认证系统样式 */
    #auth-container {
      background: rgba(255,255,255,0.9);
      padding: 20px;
      border-radius: 10px;
      max-width: 400px;
      margin: 20px auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    #auth-container h2 {
      margin-top: 0;
      text-align: center;
    }
    
    #auth-container input {
      display: block;
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    
    #auth-container button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    
    #auth-container button:hover {
      background-color: #45a049;
    }
    
    #auth-actions {
      display: flex;
      justify-content: space-between;
    }
    
    #auth-actions button {
      width: 48%;
    }
    
    #firebase-comment-form {
      margin-top: 20px;
      background: rgba(255,255,255,0.9);
      padding: 20px;
      border-radius: 10px;
    }
    
    #firebase-comment-form textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      min-height: 100px;
    }
    
    .firebase-comment {
      background: rgba(255,255,255,0.9);
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
    }
    
    .firebase-user-info {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .firebase-user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }
    
    .tab-buttons {
      display: flex;
      margin-bottom: 20px;
    }
    
    .tab-button {
      padding: 10px 20px;
      background: #ddd;
      border: none;
      cursor: pointer;
    }
    
    .tab-button.active {
      background: #4CAF50;
      color: white;
    }
  </style>
</head>
<body>
  <!-- 你的原有 HTML 结构保持不变 -->
  
  <!-- 新增的认证和评论系统 -->
  <div id="auth-container">
    <h2>登录/注册</h2>
    <input type="email" id="auth-email" placeholder="邮箱">
    <input type="password" id="auth-password" placeholder="密码">
    <div id="auth-actions">
      <button onclick="firebaseLogin()">登录</button>
      <button onclick="firebaseRegister()">注册</button>
    </div>
    <button onclick="firebaseSignOut()" style="background-color: #f44336; display: none;" id="signout-btn">退出登录</button>
  </div>
  
  <div id="firebase-comment-section" style="display: none;">
    <div class="tab-buttons">
      <button class="tab-button active" onclick="switchTab('github-tab')">GitHub 讨论</button>
      <button class="tab-button" onclick="switchTab('firebase-tab')">实时评论</button>
    </div>
    
    <!-- 保留原有的 GitHub Issues 讨论区 -->
    <div id="github-tab" class="tab-content">
      <div id="discussions"></div>
    </div>
    
    <!-- 新增的 Firebase 评论系统 -->
    <div id="firebase-tab" class="tab-content" style="display: none;">
      <div id="firebase-comment-form">
        <textarea id="firebase-comment-text" placeholder="留下你的评论..."></textarea>
        <button class="submit-button" onclick="submitFirebaseComment()"><i class="fas fa-paper-plane"></i> 提交评论</button>
      </div>
      <div id="firebase-comments-list"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  
  <script>
    // ===== Firebase 配置 =====
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    
    // 初始化 Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // ===== 认证状态监听 =====
    firebase.auth().onAuthStateChanged((user) => {
      const authContainer = document.getElementById('auth-container');
      const commentSection = document.getElementById('firebase-comment-section');
      const signoutBtn = document.getElementById('signout-btn');
      
      if (user) {
        authContainer.style.display = 'none';
        commentSection.style.display = 'block';
        signoutBtn.style.display = 'block';
        loadFirebaseComments();
      } else {
        authContainer.style.display = 'block';
        commentSection.style.display = 'none';
        signoutBtn.style.display = 'none';
      }
    });
    
    // ===== 认证功能 =====
    function firebaseLogin() {
      const email = document.getElementById('auth-email').value;
      const password = document.getElementById('auth-password').value;
      
      firebase.auth().signInWithEmailAndPassword(email, password)
        .catch((error) => {
          alert(error.message);
        });
    }
    
    function firebaseRegister() {
      const email = document.getElementById('auth-email').value;
      const password = document.getElementById('auth-password').value;
      
      firebase.auth().createUserWithEmailAndPassword(email, password)
        .catch((error) => {
          alert(error.message);
        });
    }
    
    function firebaseSignOut() {
      firebase.auth().signOut();
    }
    
    // ===== 评论功能 =====
    function submitFirebaseComment() {
      const user = firebase.auth().currentUser;
      const commentText = document.getElementById('firebase-comment-text').value.trim();
      
      if (!user) {
        alert('请先登录!');
        return;
      }
      
      if (!commentText) {
        alert('请输入评论内容!');
        return;
      }
      
      db.collection('comments').add({
        userId: user.uid,
        userEmail: user.email,
        text: commentText,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        document.getElementById('firebase-comment-text').value = '';
      }).catch((error) => {
        alert('提交评论失败: ' + error.message);
      });
    }
    
    function loadFirebaseComments() {
      const commentsList = document.getElementById('firebase-comments-list');
      
      db.collection('comments')
        .orderBy('timestamp', 'desc')
        .onSnapshot((snapshot) => {
          commentsList.innerHTML = '';
          
          snapshot.forEach((doc) => {
            const comment = doc.data();
            const commentElement = document.createElement('div');
            commentElement.className = 'firebase-comment';
            
            commentElement.innerHTML = `
              <div class="firebase-user-info">
                <img src="https://www.gravatar.com/avatar/${md5(comment.userEmail)}?d=identicon" 
                     class="firebase-user-avatar" alt="${comment.userEmail}">
                <div>
                  <div class="comment-author">${comment.userEmail.split('@')[0]}</div>
                  <div class="comment-date">${new Date(comment.timestamp?.toDate()).toLocaleString()}</div>
                </div>
              </div>
              <div class="comment-body">${comment.text}</div>
            `;
            
            commentsList.appendChild(commentElement);
          });
        }, (error) => {
          console.error('加载评论失败:', error);
          commentsList.innerHTML = '<div class="error-text"><i class="fas fa-exclamation-triangle"></i> 加载评论失败</div>';
        });
    }
    
    // 简单的 MD5 函数用于 Gravatar
    function md5(string) {
      return CryptoJS.MD5(string.trim().toLowerCase()).toString();
    }
    
    // ===== 标签切换功能 =====
    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
      });
      
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      document.getElementById(tabId).style.display = 'block';
      event.target.classList.add('active');
    }
    
    // ===== 原有的 SVIP 用户功能 =====
    let svipUsers = []; // 存储SVIP用户名单

    async function fetchSvipUsers() {
      try {
        const response = await fetch('https://muyuyv233.github.io/OptiNexus/tag/svip.txt');
        if (!response.ok) throw new Error('获取SVIP列表失败');
        const text = await response.text();
        svipUsers = text.split('\n')
          .map(name => name.trim())
          .filter(name => name.length > 0);
      } catch (error) {
        console.error('获取SVIP用户列表失败:', error);
      }
    }

    function isSvipUser(username) {
      return svipUsers.includes(username);
    }

    // ===== 修改 initialize() 函数 =====
    async function initialize() {
      initTheme();
      await fetchSvipUsers(); // 先加载SVIP名单
      try {
        await Promise.all([
          fetchAnnouncement(),
          fetchReleases(),
          fetchDiscussions()
        ]);
      } catch (error) {
        showErrorNotification(`初始化失败: ${error.message}`);
      }
    }

    // ===== 修改 fetchDiscussions() 函数 =====
    async function fetchDiscussions() {
      try {
        const response = await fetch(`https://api.github.com/repos/muyuyv233/OptiNexus/issues`);
        const issues = await response.json();

        const container = document.getElementById('discussions');
        container.innerHTML = '';
        
        issues.forEach(issue => {
          const issueDiv = document.createElement('div');
          issueDiv.className = 'issue';
          issueDiv.innerHTML = `
            <div class="issue-header">
              <div class="user-info">
                <img src="${issue.user.avatar_url}" class="avatar" alt="${issue.user.login}">
                <div class="user-details">
                  <div class="comment-author">${issue.user.login}${
                    isSvipUser(issue.user.login) ? 
                    ' <img src="https://muyuyv233.github.io/OptiNexus/assets/Svip.png" class="svip-badge" alt="SVIP">' : 
                    ''
                  }</div>
                  <div class="comment-date">${new Date(issue.created_at).toLocaleString()}</div>
                </div>
              </div>
              <h3><i class="fas fa-comment-dots"></i> ${issue.title}</h3>
              <p>${issue.body || '无内容描述'}</p>
              <button class="submit-button" onclick="loadComments(this, ${issue.number})"
                style="margin-top:15px;padding:10px 20px;">
                <i class="fas fa-comments"></i> 显示评论 (${issue.comments})
              </button>
            </div>
            <div class="comments-container" style="display:none;"></div>
          `;
          container.appendChild(issueDiv);
        });
      } catch (error) {
        console.error('获取讨论信息失败:', error);
        showErrorNotification('加载讨论失败，请稍后重试');
      }
    }

    // ===== 修改 loadComments() 函数 =====
    async function loadComments(button, issueNumber) {
      const container = button.parentElement.nextElementSibling;
      if (container.children.length === 0) {
        try {
          button.disabled = true;
          button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 加载中...';
          
          const response = await fetch(`https://api.github.com/repos/muyuyv233/OptiNexus/issues/${issueNumber}/comments`);
          const comments = await response.json();
          
          container.innerHTML = comments.map(comment => `
            <div class="comment">
              <img src="${comment.user.avatar_url}" class="avatar" alt="${comment.user.login}">
              <div class="comment-content">
                <div class="user-info">
                  <span class="comment-author">${comment.user.login}${
                    isSvipUser(comment.user.login) ? 
                    ' <img src="https://muyuyv233.github.io/OptiNexus/assets/Svip.png" class="svip-badge" alt="SVIP">' : 
                    ''
                  }</span>
                  <span class="comment-date">${new Date(comment.created_at).toLocaleString()}</span>
                </div>
                <div class="comment-body">${comment.body || '无评论内容'}</div>
              </div>
            </div>
          `).join('');
          
          button.innerHTML = `<i class="fas fa-comments"></i> 隐藏评论 (${comments.length})`;
        } catch (error) {
          console.error('获取评论失败:', error);
          container.innerHTML = '<div class="error-text"><i class="fas fa-exclamation-triangle"></i> 无法加载评论</div>';
          button.innerHTML = `<i class="fas fa-comments"></i> 显示评论 (${issueNumber})`;
        } finally {
          button.disabled = false;
        }
      }
      container.style.display = container.style.display === 'none' ? 'block' : 'none';
      button.innerHTML = container.style.display === 'none' ? 
        `<i class="fas fa-comments"></i> 显示评论 (${issueNumber})` : 
        `<i class="fas fa-comments"></i> 隐藏评论 (${issueNumber})`;
    }

    // 你的其他 JavaScript 代码保持不变...
    
    // 初始化页面
    initialize();
  </script>
  
  <!-- 添加 CryptoJS 用于 Gravatar -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</body>
</html>
